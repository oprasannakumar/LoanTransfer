<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Loan Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial;background:#f5f5f5;padding:20px}
form{position:relative;background:#fff;padding:20px;border-radius:8px;max-width:420px;margin:auto;box-shadow:0 0 10px rgba(0,0,0,.1)}
label{font-weight:bold;margin-top:10px;display:block}
input,select,textarea,button{
  width:100%;height:42px;padding:8px 10px;margin-top:5px;
  border-radius:4px;border:1px solid #ccc;box-sizing:border-box;background:#fff
}
textarea{resize:none}
button{background:#007bff;color:#fff;border:none;margin-top:15px;height:44px}
button:hover{background:#0056b3}
.cash-grey{background:#f0f0f0!important}

/* Menu */
.menu-container{position:absolute;top:12px;left:12px;padding:8px}
.menu-btn{width:36px;height:36px;border:1px solid #ccc;border-radius:6px;background:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.menu-dropdown{display:none;position:absolute;top:50px;left:0;background:#fff;border-radius:6px;min-width:230px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
.menu-container:hover .menu-dropdown{display:block}
.menu-dropdown a{display:block;padding:12px 14px;text-decoration:none;color:#000;border-bottom:1px solid #eee}
.menu-dropdown a:hover{background:#f0f0f0}

/* Cash grid */
#denominations{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.denom-row{border:1px solid #ccc;border-radius:6px;padding:10px;text-align:center;font-weight:bold}
.denom-row input{margin-top:6px;height:36px;text-align:center}

/* Popup */
.popup{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
.popup-box{background:#fff;width:90%;max-width:380px;border-radius:8px;padding:20px}
.popup-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.popup-card{border:1px solid #ccc;border-radius:6px;padding:10px;text-align:center;font-weight:bold}
.popup-actions{display:flex;gap:10px;margin-top:20px}
.popup-actions button{flex:1}
</style>
</head>

<body>

<form id="form">

<div class="menu-container">
  <div class="menu-btn">⋮</div>
  <div class="menu-dropdown">
    <a href="https://oprasannakumar.github.io/Financial-Transaction/">Financial Transactions</a>
<a href="https://oprasannakumar.github.io/Monthlyexpences/">Monthly Expenses</a>
<a href="https://oprasannakumar.github.io/SelfTransfer/">Self Transfer</a>
  </div>
</div>

<h2 style="text-align:center">Loan Entry</h2>

<label>Date</label>
<input type="date" id="date">

<label>Borrower</label>
<select id="borrower">
  <option value="">Select</option>
  <option>Chinnama</option>
  <option>Grand Father</option>
  <option>Mother</option>
  <option>Pedhamma</option>
  <option>Ravi Babai</option>
  <option>Srinivas Babai</option>
  <option>Vasavi</option>
  <option value="Other">Other</option>
</select>
<input id="borrowerOther" placeholder="Enter borrower name" style="display:none">

<label>Narration</label>
<input type="text" id="narration">

<label>Transaction Type</label>
<select id="trtype">
  <option value="">Select</option>
  <option>CASH</option>
  <option>UPI</option>
  <option>NET</option>
  <option>DEBIT</option>
  <option>CREDIT</option>
</select>

<label id="accountLbl" style="display:none">Account</label>
<select id="account" style="display:none"></select>

<div id="cashBox" style="display:none">
  <h3>Cash Denominations</h3>
  <div id="denominations"></div>
</div>

<label>Amount</label>
<input id="amount" type="number">

<button type="submit">Submit</button>
</form>

<!-- Popup -->
<div class="popup" id="popup">
  <div class="popup-box">
    <h3>Confirm Loan Entry</h3>
    <div id="popupText"></div>
    <div id="popupDenoms"></div>
    <div class="popup-actions">
      <button onclick="popup.style.display='none'">Cancel</button>
      <button onclick="send()">Confirm</button>
    </div>
  </div>
</div>

<script>
const WEBHOOK_URL="https://hook.eu1.make.com/uayw6m2h1u56gz1fuhnyewvh860q8tjy";

const bankAccounts=["FI","HDFC Old","HDFC New","ICICI","IndusInd","Kotak","RBL","SBI"];
const creditCards = [
  "Axis Flipkart","Axis MyZone","Axis Neo",
  "HDFC PhonePe","HDFC Tata Neu","HDFC Millennia",
  "HSBC","IDFC First Millenia",
  "ICICI Amazon","ICICI Coral","ICICI Expressions",
  "Indusind Plat Aura EDGE","Indusind Legend",
  "Yes Finbooster","Kotak League","Kotak Image",
  "SBI BPCL","Standard Chartered"
];
const denoms=[500,200,100,50,20,10,5,2,1];

const dWrap=document.getElementById("denominations");
denoms.forEach(d=>{
  dWrap.innerHTML+=`
  <div class="denom-row">
    ₹${d}<br>
    <input type="number" data-d="${d}" value="0">
  </div>`;
});

borrower.onchange=()=>{
  borrowerOther.style.display = borrower.value==="Other"?"block":"none";
};

/* ✅ FIXED: Proper reset when switching away from CASH */
trtype.onchange=()=>{
  // reset account UI
  account.innerHTML="";
  account.style.display="none";
  accountLbl.style.display="none";

  // reset cash UI + values
  cashBox.style.display="none";
  document.querySelectorAll("[data-d]").forEach(i=>i.value=0);

  // reset amount
  amount.readOnly=false;
  amount.classList.remove("cash-grey");
  amount.value="";

  if(!trtype.value) return;

  if(trtype.value==="CASH"){
    cashBox.style.display="block";
    amount.readOnly=true;
    amount.classList.add("cash-grey");
    return;
  }

  const list = trtype.value==="CREDIT" ? creditCards : bankAccounts;
  accountLbl.style.display="block";
  account.style.display="block";
  account.innerHTML="<option value=''>Select</option>";
  list.forEach(v=>account.innerHTML+=`<option>${v}</option>`);
};

document.addEventListener("input",e=>{
  if(e.target.dataset?.d){
    let total=0;
    document.querySelectorAll("[data-d]").forEach(i=>{
      total+=Number(i.dataset.d)*(Number(i.value)||0);
    });
    amount.value=total;
  }
});

form.onsubmit=e=>{
  e.preventDefault();

  const missing=[];
  if(!date.value) missing.push("Date");
  if(!borrower.value) missing.push("Borrower");
  if(borrower.value==="Other"&&!borrowerOther.value) missing.push("Borrower Name");
  if(!narration.value) missing.push("Narration");
  if(!trtype.value) missing.push("Transaction Type");
  if(trtype.value!=="CASH"&&!account.value) missing.push("Account");
  if(!amount.value||Number(amount.value)<=0) missing.push("Amount");

  if(missing.length){
    alert("Please fill:\n\n• "+missing.join("\n• "));
    return;
  }

  popupText.innerHTML=`
    <b>Category:</b> Loan Entry<br>
    <b>Date:</b> ${date.value}<br>
    <b>Borrower:</b> ${borrower.value==="Other"?borrowerOther.value:borrower.value}<br>
    <b>Narration:</b> ${narration.value}<br>
    <b>Type:</b> ${trtype.value}<br>
    <b>Account:</b> ${trtype.value==="CASH"?"Cash":account.value}<br>
    <b>Amount:</b> ₹${amount.value}
  `;

  popupDenoms.innerHTML="";
  if(trtype.value==="CASH"){
    popupDenoms.innerHTML="<h4>Cash Denominations</h4><div class='popup-grid'></div>";
    const g=popupDenoms.querySelector(".popup-grid");
    denoms.forEach(d=>{
      const c=document.querySelector(`[data-d="${d}"]`).value||0;
      g.innerHTML+=`<div class="popup-card">₹${d}<br>${c}</div>`;
    });
  }

  popup.style.display="flex";
};

async function send(){
  const cash={};
  document.querySelectorAll("[data-d]").forEach(i=>cash[i.dataset.d]=Number(i.value)||0);

  await fetch(WEBHOOK_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      category:"loan_entry",
      date:date.value,
      borrower:borrower.value==="Other"?borrowerOther.value:borrower.value,
      narration:narration.value,
      trtype:trtype.value,
      account:trtype.value==="CASH"?"Cash":account.value,
      amount:Number(amount.value),
      cash_denominations:cash
    })
  });

  popup.style.display="none";
  alert("Loan entry saved");
  form.reset();
  cashBox.style.display="none";
}
</script>

</body>
</html>